# Production docker-compose configuration for multi-host deployment (SUBPROJECT 3)
# Self-reliant setup with integrated MCP servers - No external dependencies
# Uses external MongoDB and Ollama services configured in .env

# This compose file automatically generates build arguments to ensure
# source code changes always trigger a rebuild (no cache issues)

services:
  # Frontend with integrated nginx (serves both static files and proxies backend)
  frontend:
    build:
      context: .
      dockerfile: docker/frontend/Dockerfile
      # These args are automatically generated by the Makefile
      args:
        BUILD_DATE: ${BUILD_DATE:-$(date -u +"%Y-%m-%dT%H:%M:%SZ")}
        GIT_COMMIT: ${GIT_COMMIT:-$(git rev-parse --short HEAD 2>/dev/null || echo "no-git")}
        CACHE_BUST: ${CACHE_BUST:-$(date +%s)}
    container_name: olympian-frontend
    restart: unless-stopped
    ports:
      - "${APP_PORT:-8080}:80"
    environment:
      DEPLOYMENT_MODE: ${DEPLOYMENT_MODE:-multi-host}
      # Use Docker service name when backend is on Docker network
      BACKEND_HOST: backend
      BACKEND_PORT: 4000
    depends_on:
      - backend
    networks:
      - olympian-network
    # Resource limits for frontend
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.25'
    healthcheck:
      test: ["CMD", "/healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    # Add extra_hosts for custom DNS resolution
    extra_hosts:
      - "host.docker.internal:host-gateway"

  backend:
    build:
      context: .
      dockerfile: docker/backend/Dockerfile
      # Backend also gets cache busting
      args:
        BUILD_DATE: ${BUILD_DATE:-$(date -u +"%Y-%m-%dT%H:%M:%SZ")}
        GIT_COMMIT: ${GIT_COMMIT:-$(git rev-parse --short HEAD 2>/dev/null || echo "no-git")}
        CACHE_BUST: ${CACHE_BUST:-$(date +%s)}
    container_name: olympian-backend
    restart: unless-stopped
    ports:
      - "4000:4000"  # Expose backend port to host if needed
    networks:
      - olympian-network
    environment:
      # Deployment mode - CRITICAL for subproject 3
      DEPLOYMENT_MODE: ${DEPLOYMENT_MODE:-multi-host}
      ENABLE_MULTI_HOST: ${ENABLE_MULTI_HOST:-true}
      
      # Docker environment indicator
      RUNNING_IN_DOCKER: "true"
      
      # MongoDB with replica set support for transactions
      # Use replica set URI to enable transactions in multi-host deployment
      MONGODB_URI: ${MONGODB_URI:-mongodb://mongodb:27017/olympian_ai_lite?replicaSet=rs0}
      OLLAMA_HOST: ${OLLAMA_HOST}
      
      # Optional: Multiple hosts for load balancing
      OLLAMA_HOSTS: ${OLLAMA_HOSTS:-}
      MCP_HOSTS: ${MCP_HOSTS:-}
      
      # Service discovery settings
      SERVICE_DISCOVERY_ENABLED: ${SERVICE_DISCOVERY_ENABLED:-true}
      SERVICE_DISCOVERY_SUBNET: ${SERVICE_DISCOVERY_SUBNET:-192.168.1.0/24}
      
      # Model capability configuration - CRITICAL for subproject 3
      MODEL_CAPABILITY_MODE: ${MODEL_CAPABILITY_MODE:-automatic}
      
      # MCP Configuration - Self-reliant container endpoints
      MCP_ENABLED: ${MCP_ENABLED:-true}
      MCP_OPTIONAL: ${MCP_OPTIONAL:-true}
      MCP_TRANSPORT: ${MCP_TRANSPORT:-http}
      MCP_CONFIG_PATH: ${MCP_CONFIG_PATH:-/app/mcp-config.multihost.json}
      
      # MCP Server Authentication
      GITHUB_PERSONAL_ACCESS_TOKEN: ${GITHUB_PERSONAL_ACCESS_TOKEN:-}
      NASA_API_KEY: ${NASA_API_KEY:-DEMO_KEY}
      BRAVE_API_KEY: ${BRAVE_API_KEY:-}
      
      # MCP Server Endpoints - Container-based (self-reliant)
      MCP_GITHUB_ENDPOINT: ${MCP_GITHUB_ENDPOINT:-http://mcp-github:3001/mcp}
      MCP_NASA_ENDPOINT: ${MCP_NASA_ENDPOINT:-http://mcp-nasa:3002/mcp}
      MCP_METMUSEUM_ENDPOINT: ${MCP_METMUSEUM_ENDPOINT:-http://mcp-metmuseum:3003/mcp}
      MCP_CONTEXT7_ENDPOINT: ${MCP_CONTEXT7_ENDPOINT:-http://mcp-context7:3004/mcp}
      MCP_APPLESCRIPT_ENDPOINT: ${MCP_APPLESCRIPT_ENDPOINT:-http://mcp-applescript:3005/mcp}
      MCP_WEBSEARCH_ENDPOINT: ${MCP_WEBSEARCH_ENDPOINT:-http://mcp-websearch:3006/mcp}
      
      # Redis Configuration - Optional for multi-host coordination
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
      REDIS_OPTIONAL: ${REDIS_OPTIONAL:-true}
      
      # Application settings
      NODE_ENV: production
      PORT: 4000
      LOG_LEVEL: ${LOG_LEVEL:-info}
      
      # Security
      JWT_SECRET: ${JWT_SECRET}
      SESSION_SECRET: ${SESSION_SECRET}
      
      # CORS settings
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:8080}
      
      # Memory tuning for vision processing
      NODE_OPTIONS: "--max-old-space-size=2048"
    volumes:
      - config-data:/config/.olympian-ai-lite
      - logs:/app/logs
      # Mount MCP configuration for subproject 3
      - ./mcp-config.multihost.json:/app/mcp-config.multihost.json:ro
      # Alternative mount path for container-based config loading
      - ./mcp-config.multihost.json:/config/mcp-config.json:ro
    depends_on:
      mongodb-replica-init:
        condition: service_completed_successfully
      # MCP servers are optional dependencies
      mcp-github:
        condition: service_started
      mcp-nasa:
        condition: service_started
      mcp-metmuseum:
        condition: service_started
      mcp-context7:
        condition: service_started
      mcp-applescript:
        condition: service_started
      mcp-websearch:
        condition: service_started
    # Resource limits for backend (increased for vision processing)
    deploy:
      resources:
        limits:
          memory: 3G
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '1.0'
    # Add extra_hosts to allow backend to access host services and custom DNS
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # ===================================
  # MCP SERVERS - Self-Reliant Container Setup
  # ===================================

  # GitHub MCP Server - Repository access, issues, PRs
  mcp-github:
    image: node:20-alpine
    container_name: olympian-mcp-github
    restart: unless-stopped
    working_dir: /app
    command: >
      sh -c "
        npm install -g @modelcontextprotocol/server-github@latest &&
        npx @modelcontextprotocol/server-github --transport http --port 3001
      "
    ports:
      - "3001:3001"
    environment:
      GITHUB_PERSONAL_ACCESS_TOKEN: ${GITHUB_PERSONAL_ACCESS_TOKEN:-}
      NODE_ENV: production
      PORT: 3001
    networks:
      - olympian-network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/health", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # NASA MCP Server - Space data and APIs
  mcp-nasa:
    image: node:20-alpine
    container_name: olympian-mcp-nasa
    restart: unless-stopped
    working_dir: /app
    command: >
      sh -c "
        npm install -g @programcomputer/nasa-mcp-server@latest &&
        npx @programcomputer/nasa-mcp-server --transport http --port 3002
      "
    ports:
      - "3002:3002"
    environment:
      NASA_API_KEY: ${NASA_API_KEY:-DEMO_KEY}
      NODE_ENV: production
      PORT: 3002
    networks:
      - olympian-network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3002/health", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # Metropolitan Museum MCP Server - Art and cultural data
  mcp-metmuseum:
    image: node:20-alpine
    container_name: olympian-mcp-metmuseum
    restart: unless-stopped
    working_dir: /app
    command: >
      sh -c "
        npm install -g metmuseum-mcp@latest &&
        npx metmuseum-mcp --transport http --port 3003
      "
    ports:
      - "3003:3003"
    environment:
      NODE_ENV: production
      PORT: 3003
    networks:
      - olympian-network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3003/health", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # Context7 MCP Server - Documentation and code assistance
  mcp-context7:
    image: node:20-alpine
    container_name: olympian-mcp-context7
    restart: unless-stopped
    working_dir: /app
    command: >
      sh -c "
        npm install -g @upstash/context7-mcp@latest &&
        npx @upstash/context7-mcp --transport http --port 3004
      "
    ports:
      - "3004:3004"
    environment:
      NODE_ENV: production
      PORT: 3004
    networks:
      - olympian-network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3004/health", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # AppleScript MCP Server - macOS automation
  mcp-applescript:
    image: node:20-alpine
    container_name: olympian-mcp-applescript
    restart: unless-stopped
    working_dir: /app
    command: >
      sh -c "
        npm install -g @sampullman/applescript-mcp@latest &&
        npx @sampullman/applescript-mcp --transport http --port 3005
      "
    ports:
      - "3005:3005"
    environment:
      NODE_ENV: production
      PORT: 3005
    networks:
      - olympian-network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3005/health", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # Web Search MCP Server - Search capabilities
  mcp-websearch:
    image: node:20-alpine
    container_name: olympian-mcp-websearch
    restart: unless-stopped
    working_dir: /app
    command: >
      sh -c "
        npm install -g @modelcontextprotocol/server-brave-search@latest &&
        npx @modelcontextprotocol/server-brave-search --transport http --port 3006
      "
    ports:
      - "3006:3006"
    environment:
      BRAVE_API_KEY: ${BRAVE_API_KEY:-}
      NODE_ENV: production
      PORT: 3006
    networks:
      - olympian-network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3006/health", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ===================================
  # CORE INFRASTRUCTURE SERVICES
  # ===================================

  # MongoDB configured as single-node replica set for transaction support
  mongodb:
    image: mongo:7
    container_name: olympian-mongodb
    restart: unless-stopped
    command: mongod --replSet rs0 --bind_ip_all --port 27017
    volumes:
      - mongodb-data:/data/db
      - mongodb-config:/data/configdb
    environment:
      MONGO_INITDB_DATABASE: olympian_ai_lite
    networks:
      - olympian-network
    # Resource limits for MongoDB
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    healthcheck:
      test: |
        test $$(mongosh --quiet --eval "
          try {
            db.runCommand({ping: 1}).ok
          } catch(e) {
            0
          }
        ") -eq 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Replica set initialization service
  mongodb-replica-init:
    image: mongo:7
    container_name: olympian-mongodb-replica-init
    restart: "no"
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - olympian-network
    command: |
      mongosh --host mongodb:27017 --eval '
        try {
          rs.status();
          print("✅ Replica set already initialized");
        } catch(e) {
          print("🔧 Initializing replica set...");
          rs.initiate({
            _id: "rs0",
            members: [
              {
                _id: 0,
                host: "mongodb:27017"
              }
            ]
          });
          
          // Wait for replica set to be ready
          var attempts = 0;
          while (attempts < 30) {
            try {
              var status = rs.status();
              if (status.members[0].state === 1) {
                print("✅ Replica set initialized successfully");
                print("📊 MongoDB replica set status:", JSON.stringify(status, null, 2));
                break;
              }
            } catch(e) {
              print("⏳ Waiting for replica set to be ready... attempt", attempts + 1);
            }
            attempts++;
            sleep(1000);
          }
          
          if (attempts >= 30) {
            print("❌ Failed to initialize replica set after 30 attempts");
            quit(1);
          }
        }
      '

  # Redis service for multi-host coordination (optional)
  redis:
    image: redis:7-alpine
    container_name: olympian-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - olympian-network
    # Resource limits for Redis
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

volumes:
  config-data:
  logs:
  mongodb-data:
  mongodb-config:
  redis-data:

networks:
  olympian-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16